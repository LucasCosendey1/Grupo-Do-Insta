#!/bin/bash

echo "üîß ============================================"
echo "üîß CORRE√á√ÉO AUTOM√ÅTICA: FOTOS QUEBRADAS"
echo "üîß ============================================"
echo ""

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Fun√ß√£o para backup
backup_file() {
    local file=$1
    if [ -f "$file" ]; then
        echo -e "${YELLOW}üì¶ Backup: $file ‚Üí $file.backup${NC}"
        cp "$file" "$file.backup"
    fi
}

echo "1Ô∏è‚É£ CRIANDO BACKUPS..."
echo "-------------------------------------------"
backup_file "app/api/image-proxy/route.js"
backup_file "app/api/scrape/route.js"
echo -e "${GREEN}‚úÖ Backups criados!${NC}"
echo ""

echo "2Ô∏è‚É£ SUBSTITUINDO ARQUIVOS..."
echo "-------------------------------------------"

# Image Proxy
if [ -f "app/api/image-proxy-fixed/route.js" ]; then
    echo "üì∏ Aplicando corre√ß√£o do Image Proxy..."
    mv app/api/image-proxy-fixed/route.js app/api/image-proxy/route.js
    echo -e "${GREEN}‚úÖ Image Proxy corrigido!${NC}"
else
    echo -e "${RED}‚ùå app/api/image-proxy-fixed/route.js n√£o encontrado${NC}"
fi

# Scrape
if [ -f "app/api/scrape-fixed/route.js" ]; then
    echo "üîç Aplicando corre√ß√£o do Scrape..."
    mv app/api/scrape-fixed/route.js app/api/scrape/route.js
    echo -e "${GREEN}‚úÖ Scrape corrigido!${NC}"
else
    echo -e "${RED}‚ùå app/api/scrape-fixed/route.js n√£o encontrado${NC}"
fi

# Verificar se image-utils foi criado
if [ -f "lib/image-utils.ts" ]; then
    echo -e "${GREEN}‚úÖ lib/image-utils.ts encontrado!${NC}"
else
    echo -e "${RED}‚ùå lib/image-utils.ts n√£o encontrado${NC}"
    echo "   Voc√™ precisa criar este arquivo primeiro!"
fi

echo ""

echo "3Ô∏è‚É£ VERIFICANDO ESTRUTURA..."
echo "-------------------------------------------"

# Verificar arquivos essenciais
files=(
    "app/api/image-proxy/route.js"
    "app/api/scrape/route.js"
    "lib/image-utils.ts"
)

all_ok=true
for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        echo -e "${GREEN}‚úÖ $file${NC}"
    else
        echo -e "${RED}‚ùå $file FALTANDO${NC}"
        all_ok=false
    fi
done

echo ""

if [ "$all_ok" = true ]; then
    echo "4Ô∏è‚É£ LIMPANDO CACHE..."
    echo "-------------------------------------------"
    
    if [ -d ".next" ]; then
        echo "üßπ Removendo pasta .next..."
        rm -rf .next
        echo -e "${GREEN}‚úÖ Cache limpo!${NC}"
    fi
    
    echo ""
    echo "5Ô∏è‚É£ INSTALANDO DEPEND√äNCIAS..."
    echo "-------------------------------------------"
    npm install
    
    echo ""
    echo "============================================"
    echo -e "${GREEN}‚úÖ CORRE√á√ïES APLICADAS COM SUCESSO!${NC}"
    echo "============================================"
    echo ""
    echo "üìã PR√ìXIMOS PASSOS:"
    echo ""
    echo "1. Testar localmente:"
    echo "   npm run dev"
    echo ""
    echo "2. Abrir http://localhost:3000"
    echo ""
    echo "3. Criar um grupo e verificar se fotos aparecem"
    echo ""
    echo "4. Se funcionar, fazer deploy:"
    echo "   git add ."
    echo "   git commit -m \"fix: Corrigir fotos quebradas\""
    echo "   git push"
    echo ""
    echo "üí° LOGS IMPORTANTES:"
    echo "   Procure por: üì∏ [IMAGE-PROXY] ou ‚ùå [IMAGE-PROXY]"
    echo ""
else
    echo "============================================"
    echo -e "${RED}‚ùå CORRE√á√ÉO INCOMPLETA${NC}"
    echo "============================================"
    echo ""
    echo "Arquivos faltando. Verifique:"
    echo "1. lib/image-utils.ts existe?"
    echo "2. app/api/image-proxy-fixed/route.js existe?"
    echo "3. app/api/scrape-fixed/route.js existe?"
    echo ""
fi

echo ""
echo "üìÅ BACKUPS SALVOS EM:"
echo "   - app/api/image-proxy/route.js.backup"
echo "   - app/api/scrape/route.js.backup"
echo ""
echo "‚ö†Ô∏è  Para reverter:"
echo "   mv app/api/image-proxy/route.js.backup app/api/image-proxy/route.js"
echo "   mv app/api/scrape/route.js.backup app/api/scrape/route.js"
echo ""